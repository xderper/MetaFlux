# 🧹 Руководство по полной очистке и пересборке проекта

## Описание

Скрипт `clean-rebuild.sh` предназначен для полной очистки и пересборки проекта на VPS с нуля. Он выполняет комплексную очистку всех кешей, временных файлов и пересобирает Docker контейнеры.

## Когда использовать

- 🐛 При проблемах с кешированием
- 🔄 После значительных изменений в коде
- 🚀 При подготовке к важному релизу
- 💾 Когда заканчивается место на диске
- 🔧 При проблемах с зависимостями
- 🌟 Для "чистого старта" проекта

## Использование

### Базовый запуск

```bash
# Перейти в директорию проекта
cd /path/to/your/project

# Запустить скрипт
bash clean-rebuild.sh
```

### Альтернативный способ

```bash
# Сделать скрипт исполняемым (если еще не сделано)
chmod +x clean-rebuild.sh

# Запустить
./clean-rebuild.sh
```

## Что делает скрипт

### 1. Docker очистка
- ⏹️ Останавливает все Docker контейнеры
- 🗑️ Удаляет все контейнеры
- 🖼️ Удаляет Docker образы проекта
- 📦 Очищает volumes и networks
- 🧹 Выполняет полную очистку Docker системы

### 2. Node.js очистка
- 🗑️ Очищает npm кеш
- 📁 Удаляет node_modules
- 🔒 Удаляет package-lock.json
- ⚡ Очищает кеш Next.js (.next, out)
- 🧹 Удаляет временные файлы

### 3. Пересборка
- 📦 Переустанавливает зависимости
- 🐳 Собирает Docker образы без кеша
- 🚀 Запускает новые контейнеры
- ✅ Проверяет статус

## Время выполнения

- **Быстрая очистка**: 2-5 минут
- **Полная пересборка**: 10-20 минут
- **На медленном VPS**: до 30 минут

## Примеры использования

### Стандартный запуск
```bash
cd /var/www/metaflux
bash clean-rebuild.sh
```

### С логированием
```bash
bash clean-rebuild.sh 2>&1 | tee rebuild.log
```

### В фоновом режиме
```bash
nohup bash clean-rebuild.sh > rebuild.log 2>&1 &
```

## Проверка результата

После выполнения скрипта проверьте:

```bash
# Статус контейнеров
docker ps

# Логи приложения
docker-compose logs -f

# Свободное место
df -h

# Доступность сайта
curl -I http://your-domain.com
```

## Возможные проблемы и решения

### Ошибка "Permission denied"
```bash
chmod +x clean-rebuild.sh
sudo bash clean-rebuild.sh
```

### Недостаточно места на диске
```bash
# Очистить системные логи
sudo journalctl --vacuum-time=7d

# Очистить старые пакеты
sudo apt autoremove
sudo apt autoclean
```

### Docker не отвечает
```bash
sudo systemctl restart docker
sudo reboot  # в крайнем случае
```

## Безопасность

⚠️ **ВНИМАНИЕ**: Скрипт удаляет ВСЕ Docker контейнеры и образы!

### Перед запуском:
- 💾 Сделайте бэкап важных данных
- 📋 Убедитесь, что нет других важных контейнеров
- 🔍 Проверьте текущие запущенные сервисы

### Команды для проверки:
```bash
# Проверить запущенные контейнеры
docker ps -a

# Проверить образы
docker images

# Проверить volumes с данными
docker volume ls
```

## Кастомизация

Вы можете изменить скрипт под свои нужды:

### Сохранить определенные образы
Замените строку удаления образов на более точную:
```bash
docker images | grep "your-specific-image" | awk '{print $3}' | xargs docker rmi -f
```

### Пропустить npm install
Закомментируйте строки:
```bash
# npm install
```

### Использовать yarn вместо npm
Замените:
```bash
yarn cache clean
rm -rf yarn.lock
yarn install
```

## Мониторинг процесса

### Просмотр логов в реальном времени
```bash
tail -f rebuild.log
```

### Мониторинг ресурсов
```bash
# В отдельном терминале
watch -n 2 "docker stats --no-stream && echo '---' && df -h"
```

## После успешного завершения

✅ **Все готово!** Ваш проект полностью пересобран с чистого листа.

### Следующие шаги:
1. 🌐 Проверьте доступность сайта
2. 📊 Проверьте логи на ошибки
3. 🧪 Выполните тестирование основных функций
4. 📈 Мониторьте производительность

---

💡 **Совет**: Добавьте этот скрипт в cron для автоматической очистки раз в месяц:
```bash
# Каждое 1 число месяца в 3:00
0 3 1 * * cd /var/www/metaflux && bash clean-rebuild.sh > /var/log/clean-rebuild.log 2>&1
``` 